<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ECHO Project Moçambique</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #003366;
            --accent: #C8102E;
            --bg-gray: #f2f4f7;
            --card-radius: 20px;
        }

        body { 
            background-color: var(--bg-gray); 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* Estilo App Shell */
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        
        .form-card { 
            background: white; 
            border-radius: var(--card-radius); 
            padding: 24px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.06); 
            border: none;
            margin: 10px;
        }

        /* Cabeçalhos Modernos */
        .app-header {
            text-align: center;
            padding: 30px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, #004d99 100%);
            color: white;
            border-radius: 0 0 30px 30px;
            margin-bottom: 20px;
        }

        .section-header { 
            color: var(--primary); 
            margin: 25px 0 15px 0; 
            font-weight: 700; 
            font-size: 0.95rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }

        .section-header i { margin-right: 10px; color: var(--accent); }

        /* Inputs Estilo App */
        .form-label { font-weight: 600; font-size: 0.85rem; color: #666; margin-left: 5px; }
        
        .form-control, .form-select {
            border-radius: 12px;
            padding: 14px 16px;
            border: 1px solid #e0e4e8;
            background-color: #f9fbff;
            font-size: 16px; /* Evita zoom no iOS */
            transition: all 0.2s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(0,51,102,0.08);
            background-color: white;
        }

        /* Botão Mobile-First */
        .btn-submit {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 18px;
            font-weight: 700;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 8px 15px rgba(0,51,102,0.2);
            transition: transform 0.1s;
        }

        .btn-submit:active { transform: scale(0.96); }

        /* Loader Personalizado */
        .loading-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.95); z-index: 10000; 
            justify-content: center; align-items: center; flex-direction: column; 
        }

        #loginScreen { justify-content: center; height: 100vh; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-grow text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 fw-bold text-primary" id="loaderText">A validar...</p>
</div>

<div class="app-container">
    
    <div id="loginScreen" class="p-3">
        <div class="form-card text-center">
            <img src="Novo logo ECHO 2025.png" alt="ECHO" class="mb-4" style="width: 180px;" onerror="this.src='https://via.placeholder.com/180x80?text=ECHO+PROJECT'">
            <h3 class="fw-bold mb-2" style="color: var(--primary)">Bem-vindo</h3>
            <p class="text-muted mb-4 px-3">Inicie sessão com o seu e-mail institucional para aceder ao formulário.</p>
            
            <div id="g_id_onload"
                 data-client_id="895843191645-1ioi0feh6ocfu4dabghbda88bagjhrg8.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse">
            </div>
            <div class="g_id_signin d-flex justify-content-center" data-type="standard" data-shape="pill"></div>
        </div>
    </div>

    <div id="appContent">
        <div class="app-header">
            <img src="Novo logo ECHO 2025.png" alt="ECHO" style="width: 140px; filter: brightness(0) invert(1);" class="mb-3">
            <h5 class="fw-bold mb-0">Projecto ECHO</h5>
            <small class="opacity-75">Actualização de Dados do Paciente</small>
        </div>

        <div class="form-card">
            <form id="appForm">
                <div class="section-header"><i class="fas fa-map-marked-alt"></i> Localização US</div>
                
                <div class="mb-3">
                    <label class="form-label">Província</label>
                    <select id="prov" class="form-select" required onchange="filtrarDistritos()">
                        <option value="">Seleccione...</option>
                        <option value="Manica">Manica</option>
                        <option value="Niassa">Niassa</option>
                        <option value="Sofala">Sofala</option>
                        <option value="Tete">Tete</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Distrito</label>
                    <select id="dist" class="form-select" required disabled onchange="filtrarUS()"><option value="">Seleccione...</option></select>
                </div>

                <div class="mb-3">
                    <label class="form-label">Unidade Sanitária</label>
                    <select id="us" class="form-select" required disabled><option value="">Seleccione...</option></select>
                </div>

                <div class="section-header"><i class="fas fa-id-card"></i> Dados do Paciente</div>
                
                <div class="mb-3">
                    <label class="form-label">NID</label>
                    <input type="text" id="nid" class="form-control" placeholder="0000000000/0000/00000" required oninput="aplicarMascaraNID(this)">
                </div>

                <div class="form-check form-switch mb-3 mt-4">
                    <input class="form-check-input" type="checkbox" id="temConfidente" onchange="toggleConfidente()">
                    <label class="form-check-label fw-bold" for="temConfidente">Paciente tem Confidente?</label>
                </div>

                <div id="camposConfidente" style="display:none; padding:15px; border-radius:15px; background: #fcf1f2; border: 1px solid #f5d6d9">
                    <div class="mb-3">
                        <label class="form-label">Nome do Confidente</label>
                        <input type="text" id="nomeConfidente" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Telefone do Confidente</label>
                        <input type="tel" id="telConfidente" class="form-control" placeholder="84/82...">
                    </div>
                </div>

                <div class="section-header"><i class="fas fa-phone-alt"></i> Contactos e Morada</div>
                
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label">Telefone 1</label>
                        <input type="tel" id="tel1" class="form-control" placeholder="84..." required>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label">Telefone 2</label>
                        <input type="tel" id="tel2" class="form-control" placeholder="82...">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Morada (Bairro, Quarteirão...)</label>
                    <textarea id="endereco" class="form-control" rows="2" placeholder="Descreva a localização..." required></textarea>
                </div>

                <div class="mb-4">
                    <label class="form-label">Nome do Digitador</label>
                    <input type="text" id="responsavel" class="form-control" required>
                </div>

                <button type="submit" class="btn-submit">SUBMETER REGISTO</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiH7DLonvttzbczDGe_3hjaaV0Ql9sREqsBzcscZr0nyBj6HtFVlIYiK60MZq1T5Bq7A/exec";
let userEmail = "";
let dadosTemporarios = {};

// --- LOGIN COM VALIDAÇÃO ---
function parseJwt(t) { return JSON.parse(atob(t.split('.')[1].replace(/-/g, '+').replace(/_/g, '/'))); }

async function handleCredentialResponse(response) {
    const payload = parseJwt(response.credential);
    const emailAValidar = payload.email.toLowerCase().trim();
    document.getElementById("loader").style.display = "flex";

    try {
        const res = await fetch(`${SCRIPT_URL}?check=${encodeURIComponent(emailAValidar)}`);
        const texto = await res.text();
        if (texto.includes("AUTORIZADO")) {
            userEmail = emailAValidar;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContent").style.display = "block";
        } else {
            Swal.fire({ icon: 'error', title: 'Acesso Negado', text: 'O e-mail não consta na lista de autorizados.' });
        }
    } catch (e) {
        Swal.fire({ icon: 'warning', title: 'Erro de Ligação', text: 'Não foi possível validar o acesso.' });
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}

// --- BASE DE DADOS E FILTROS (Igual à anterior) ---
const baseDados = {
    "Manica": {
        "Barue": ["Catandica HD", "Chuala CS", "Cruz de M", "Honde CS", "Nhampass", "Nhassacar", "Nhazonia C"],
        "Chimoio": ["1º Maio CS", "7 de Abril (Chimoio)", "Chimoio HP", "Chimoio_F", "Chissui CS", "Eduardo M", "Nhamaonh", "Vila Nova"],
        "Gondola": ["Amatonga", "Gondola S", "Inchope CS", "Muda Serr"],
        "Guro": ["Guro - Sed", "Mandie CS"],
        "Macate": ["Macate CS", "Marera CS", "Zembe Cer"],
        "Machaze": ["Bassane CS", "Chipopopo", "Chipudji C", "Chitobe CS", "Mavende C", "Mazwissan", "Save CS"],
        "Manica": ["4º Congres", "Machipanc", "Manica HD", "Messica C"],
        "Mossurize": ["Chaiva CS", "Dacata CS", "Espungabe", "Garagua C", "Gunhe CS", "Mude CS", "Mupengo C"],
        "Sussundenga": ["Darue CS", "Dombe CS", "Munhinga", "Sembezea", "Sussunder"],
        "Vanduzi": ["Chigodole", "IAC CS", "Matsinho", "Pungue Su", "Vanduzi C"]
    },
    "Niassa": {
        "Cuamba": ["Adine 3 CS", "Cuamba CS", "Cuamba H", "Meripo CS", "Mitucué C"],
        "Lago": ["Metangula"],
        "Lichinga": ["Chiuaula F", "CS Liching", "Lichinga H", "Lulimire C", "Namacula"],
        "Mandimba": ["Mandimba", "Mitande C"],
        "Mecanhelas": ["Chissaua C", "Entre-Lago", "Mecanhela"],
        "Metarica": ["Metarica C"],
        "Ngauma": ["Massangu"]
    },
    "Sofala": {
        "Beira": ["Cadeia Pro", "Cerâmica C", "Chamba P", "Chota PS", "Hospital C", "M. Mascar", "Macurung", "Manga Lof", "Manga Nh", "Marrocanh", "Matadouro", "Munhava C", "Nhangau C", "Ponta Gêa", "Inhamizua"],
        "Buzi": ["Ampara PS", "Bandua CS", "Bura CS", "Buzi Sede", "Guara-Gua"],
        "Caia": ["Caia HD", "Murraça C", "Nhambalo", "Sena CS"],
        "Cheringoma": ["Inhaminga"],
        "Chibabava": ["Chibabava", "Hoode PS", "Mutindire", "Muxungue"],
        "Dondo": ["Canhandul", "Dondo Sed", "Igreja Bapt", "Mafambiss", "Maxarote F", "Mutua PS", "Samora M", "Savane PS"],
        "Gorongosa": ["Gorongoza"],
        "Machanga": ["Machang C"],
        "Marromeu": ["Marromeu", "Nensa CS"],
        "Nhamatanda": ["Chirassicu", "Lamego CS", "Metuchira", "Nhamatan", "Nharuchon", "Siluvo PS", "Tica PS"]
    },
    "Tete": {
        "Angonia": ["Dómue CS", "Lifidzi CS", "Ulongue CS", "Ulongue H"],
        "Cahora Bassa": ["Chitima CS", "Songo HR"],
        "Changara": ["Changara C", "Dzunga CS", "M'Saua Po", "Mazoe Por"],
        "Chiuta": ["Manje CS"],
        "Macanga": ["Furancung"],
        "Magoe": ["Daque CS", "Magoe CS", "Mucumbur"],
        "Marara": ["Boroma CS", "Cachembe"],
        "Moatize": ["25 de Sete", "Caphirizan", "Cateme CS", "CFM CS", "Mameme I", "Moatize C", "Ncondezi", "Zobue CS"],
        "Mutarara": ["Inhangoma", "Mutarara H"],
        "Tete": ["Mpadue CS", "Nº 1 - Bair", "Nº 2 - Bair", "Nº 3 - Bair", "Nº 4 - Bair", "Tete HP"]
    }
};

function filtrarDistritos() {
    const prov = document.getElementById("prov").value;
    const ds = document.getElementById("dist");
    ds.innerHTML = '<option value="">Seleccione o distrito...</option>';
    if (prov) { ds.disabled = false; Object.keys(baseDados[prov]).sort().forEach(d => ds.options.add(new Option(d, d))); }
}

function filtrarUS() {
    const prov = document.getElementById("prov").value;
    const dist = document.getElementById("dist").value;
    const us = document.getElementById("us");
    us.innerHTML = '<option value="">Seleccione a US...</option>';
    if (dist) { us.disabled = false; baseDados[prov][dist].sort().forEach(u => us.options.add(new Option(u, u))); }
}

function aplicarMascaraNID(i) { i.value = i.value.replace(/\D/g, "").substring(0,19); }
function toggleConfidente() { document.getElementById("camposConfidente").style.display = document.getElementById("temConfidente").checked ? "block" : "none"; }

// --- SUBMISSÃO ---
document.getElementById('appForm').onsubmit = function(e) {
    e.preventDefault();
    dadosTemporarios = {
        email_usuario: userEmail,
        provincia: document.getElementById("prov").value,
        distrito: document.getElementById("dist").value,
        us: document.getElementById("us").value,
        nid: document.getElementById("nid").value,
        tem_confidente: document.getElementById("temConfidente").checked ? "Sim" : "Não",
        nome_confidente: document.getElementById("nomeConfidente").value || "N/A",
        tel_confidente: document.getElementById("telConfidente").value || "N/A",
        tel1: document.getElementById("tel1").value,
        tel2: document.getElementById("tel2").value || "N/A",
        endereco: document.getElementById("endereco").value,
        responsavel: document.getElementById("responsavel").value
    };

    Swal.fire({
        title: 'Confirmar Dados?',
        html: `<div class="text-start" style="font-size: 0.9rem">
                <b>US:</b> ${dadosTemporarios.us}<br>
                <b>NID:</b> ${dadosTemporarios.nid}<br>
                <b>Tel:</b> ${dadosTemporarios.tel1}</div>`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Sim, Gravar',
        cancelButtonText: 'Rever',
        confirmButtonColor: '#003366'
    }).then((result) => {
        if (result.isConfirmed) obterGpsEGravar();
    });
};

function obterGpsEGravar() {
    document.getElementById("loader").style.display = "flex";
    document.getElementById("loaderText").innerText = "A obter GPS e a enviar...";
    
    navigator.geolocation.getCurrentPosition((pos) => {
        dadosTemporarios.latitude = pos.coords.latitude;
        dadosTemporarios.longitude = pos.coords.longitude;
        enviar();
    }, () => {
        dadosTemporarios.latitude = "Sem GPS";
        dadosTemporarios.longitude = "Sem GPS";
        enviar();
    }, { timeout: 8000 });
}

function enviar() {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dadosTemporarios) })
    .then(() => {
        Swal.fire({ icon: 'success', title: 'Sucesso!', text: 'Dados enviados para o SESP.', confirmButtonColor: '#003366' })
        .then(() => location.reload());
    })
    .catch(() => {
        Swal.fire({ icon: 'error', title: 'Erro', text: 'Não foi possível enviar.' });
        document.getElementById("loader").style.display = "none";
    });
}
</script>
</body>
</html>
