<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHO Project Mo√ßambique - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 600px; margin-top: 30px; }
        .form-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-top: 8px solid #C8102E; }
        .logo-container { text-align: center; margin-bottom: 15px; }
        .logo-container img { max-width: 220px; }
        .section-header { background: #003366; color: white; padding: 8px 15px; border-radius: 5px; margin: 20px 0 15px 0; font-weight: bold; font-size: 0.9rem; }
        #appContent { display: none; } /* Escondido at√© login */
        #loginScreen { text-align: center; padding: 50px 20px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-border text-danger" role="status"></div>
    <p class="mt-2 fw-bold">A processar...</p>
</div>

<div class="container mb-5">
    <div id="loginScreen" class="form-card">
        <div class="logo-container">
            <img src="Novo logo ECHO 2025.png" alt="Logo ECHO" onerror="this.src='https://via.placeholder.com/200x80?text=ECHO+PROJECT'">
        </div>
        <h4 class="mb-4" style="color:#003366">Acesso Restrito</h4>
        <p class="text-muted mb-4">Por favor, fa√ßa login com o seu e-mail autorizado para aceder ao formul√°rio de actualiza√ß√£o.</p>
        <div id="g_id_onload"
             data-client_id="895843191645-1ioi0feh6ocfu4dabghbda88bagjhrg8.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin d-flex justify-content-center" data-type="standard"></div>
    </div>

    <div id="appContent" class="form-card">
        <div class="logo-container">
            <img src="Novo logo ECHO 2025.png" alt="Logo ECHO">
        </div>
        <div class="text-center mb-4">
            <h2 style="color: #003366; font-weight: 800; font-size: 1.4rem;">PROJECTO ECHO</h2>
            <small class="fw-bold" style="color: #C8102E;">Actualiza√ß√£o de Endere√ßos e Contactos</small>
        </div>

        <form id="appForm">
            <div class="section-header">üìç LOCALIZA√á√ÉO DA US</div>
            <div class="mb-3">
                <label class="form-label">Prov√≠ncia</label>
                <select id="prov" class="form-select" required onchange="filtrarDistritos()">
                    <option value="">Seleccione...</option>
                    <option value="Manica">Manica</option>
                    <option value="Niassa">Niassa</option>
                    <option value="Sofala">Sofala</option>
                    <option value="Tete">Tete</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Distrito</label>
                <select id="dist" class="form-select" required disabled onchange="filtrarUS()">
                    <option value="">Seleccione o distrito...</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Unidade Sanit√°ria (US)</label>
                <select id="us" class="form-select" required disabled>
                    <option value="">Seleccione a US...</option>
                </select>
            </div>

            <div class="section-header">üÜî IDENTIFICA√á√ÉO DO PACIENTE</div>
            <div class="mb-3">
                <label class="form-label">NID (10/4/5 d√≠gitos)</label>
                <input type="text" id="nid" class="form-control" maxlength="21" placeholder="0000000000/0000/00000" required oninput="aplicarMascaraNID(this)">
            </div>

            <div class="form-check mb-3">
                <input class="form-check-input" type="checkbox" id="temConfidente" onchange="toggleConfidente()">
                <label class="form-check-label fw-bold" for="temConfidente" style="color: #C8102E;">Tem Confidente?</label>
            </div>

            <div id="camposConfidente" style="display:none; background:#f8f9fa; padding:15px; border-radius:10px; border:1px dashed #003366">
                <div class="mb-3">
                    <label class="form-label">Nome do Confidente</label>
                    <input type="text" id="nomeConfidente" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="form-label">Telefone do Confidente</label>
                    <input type="tel" id="telConfidente" class="form-control" pattern="8[2-7][0-9]{7}" placeholder="84/82...">
                </div>
            </div>

            <div class="section-header">üìû CONTACTOS E MORADA</div>
            <div class="row">
                <div class="col-6 mb-3">
                    <label class="form-label">Telefone 1</label>
                    <input type="tel" id="tel1" class="form-control" pattern="8[2-7][0-9]{7}" placeholder="84...">
                </div>
                <div class="col-6 mb-3">
                    <label class="form-label">Telefone 2</label>
                    <input type="tel" id="tel2" class="form-control" pattern="8[2-7][0-9]{7}" placeholder="82...">
                </div>
            </div>
            <div class="mb-3">
                <label class="form-label">Endere√ßo F√≠sico (Bairro, Q, Casa)</label>
                <textarea id="endereco" class="form-control" rows="2" required></textarea>
            </div>

            <div class="mb-4">
                <label class="form-label">Nome do Digitador</label>
                <input type="text" id="responsavel" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-primary w-100 p-3 fw-bold shadow" style="background-color:#003366; border:none">SUBMETER REGISTO</button>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title">Rever Dados</h5>
            </div>
            <div class="modal-body" id="resumoDados"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Corrigir</button>
                <button type="button" id="btnFinalConfirm" class="btn btn-success">Confirmar e Gravar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- CONFIGURA√á√ïES ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiH7DLonvttzbczDGe_3hjaaV0Ql9sREqsBzcscZr0nyBj6HtFVlIYiK60MZq1T5Bq7A/exec";
let userEmail = "";
let dadosTemporarios = {};

// --- LOGIN E SEGURAN√áA ---
function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(window.atob(base64));
}

function handleCredentialResponse(response) {
    const data = parseJwt(response.credential);
    userEmail = data.email;
    document.getElementById("loginScreen").style.display = "none";
    document.getElementById("appContent").style.display = "block";
    alert("Bem-vindo, " + data.name + " (" + userEmail + ")");
}

// --- BASE DE DADOS (151 US) ---
const baseDados = {
    "Manica": {
        "Barue": ["Catandica HD", "Chuala CS", "Cruz de M", "Honde CS", "Nhampass", "Nhassacar", "Nhazonia C"],
        "Chimoio": ["1¬∫ Maio CS", "7 de Abril (Chimoio)", "Chimoio HP", "Chimoio_F", "Chissui CS", "Eduardo M", "Nhamaonh", "Vila Nova"],
        "Gondola": ["Amatonga", "Gondola S", "Inchope CS", "Muda Serr"],
        "Guro": ["Guro - Sed", "Mandie CS"],
        "Macate": ["Macate CS", "Marera CS", "Zembe Cer"],
        "Machaze": ["Bassane CS", "Chipopopo", "Chipudji C", "Chitobe CS", "Mavende C", "Mazwissan", "Save CS"],
        "Manica": ["4¬∫ Congres", "Machipanc", "Manica HD", "Messica C"],
        "Mossurize": ["Chaiva CS", "Dacata CS", "Espungabe", "Garagua C", "Gunhe CS", "Mude CS", "Mupengo C"],
        "Sussundenga": ["Darue CS", "Dombe CS", "Munhinga", "Sembezea", "Sussunder"],
        "Vanduzi": ["Chigodole", "IAC CS", "Matsinho", "Pungue Su", "Vanduzi C"]
    },
    "Niassa": {
        "Cuamba": ["Adine 3 CS", "Cuamba CS", "Cuamba H", "Meripo CS", "Mitucu√© C"],
        "Lago": ["Metangula"],
        "Lichinga": ["Chiuaula F", "CS Liching", "Lichinga H", "Lulimire C", "Namacula"],
        "Mandimba": ["Mandimba", "Mitande C"],
        "Mecanhelas": ["Chissaua C", "Entre-Lago", "Mecanhela"],
        "Metarica": ["Metarica C"],
        "Ngauma": ["Massangu"]
    },
    "Sofala": {
        "Beira": ["Cadeia Pro", "Cer√¢mica C", "Chamba P", "Chota PS", "Hospital C", "M. Mascar", "Macurung", "Manga Lof", "Manga Nh", "Marrocanh", "Matadouro", "Munhava C", "Nhangau C", "Ponta G√™a", "Inhamizua"],
        "Buzi": ["Ampara PS", "Bandua CS", "Bura CS", "Buzi Sede", "Guara-Gua"],
        "Caia": ["Caia HD", "Murra√ßa C", "Nhambalo", "Sena CS"],
        "Cheringoma": ["Inhaminga"],
        "Chibabava": ["Chibabava", "Hoode PS", "Mutindire", "Muxungue"],
        "Dondo": ["Canhandul", "Dondo Sed", "Igreja Bapt", "Mafambiss", "Maxarote F", "Mutua PS", "Samora M", "Savane PS"],
        "Gorongosa": ["Gorongoza"],
        "Machanga": ["Machang C"],
        "Marromeu": ["Marromeu", "Nensa CS"],
        "Nhamatanda": ["Chirassicu", "Lamego CS", "Metuchira", "Nhamatan", "Nharuchon", "Siluvo PS", "Tica PS"]
    },
    "Tete": {
        "Angonia": ["D√≥mue CS", "Lifidzi CS", "Ulongue CS", "Ulongue H"],
        "Cahora Bassa": ["Chitima CS", "Songo HR"],
        "Changara": ["Changara C", "Dzunga CS", "M'Saua Po", "Mazoe Por"],
        "Chiuta": ["Manje CS"],
        "Macanga": ["Furancung"],
        "Magoe": ["Daque CS", "Magoe CS", "Mucumbur"],
        "Marara": ["Boroma CS", "Cachembe"],
        "Moatize": ["25 de Sete", "Caphirizan", "Cateme CS", "CFM CS", "Mameme I", "Moatize C", "Ncondezi", "Zobue CS"],
        "Mutarara": ["Inhangoma", "Mutarara H"],
        "Tete": ["Mpadue CS", "N¬∫ 1 - Bair", "N¬∫ 2 - Bair", "N¬∫ 3 - Bair", "N¬∫ 4 - Bair", "Tete HP"]
    }
};

// --- LOGICA FORMUL√ÅRIO ---
function filtrarDistritos() {
    const prov = document.getElementById("prov").value;
    const distSelect = document.getElementById("dist");
    distSelect.innerHTML = '<option value="">Seleccione...</option>';
    if (prov) {
        distSelect.disabled = false;
        Object.keys(baseDados[prov]).sort().forEach(d => distSelect.options.add(new Option(d, d)));
    }
}

function filtrarUS() {
    const prov = document.getElementById("prov").value;
    const dist = document.getElementById("dist").value;
    const usSelect = document.getElementById("us");
    usSelect.innerHTML = '<option value="">Seleccione...</option>';
    if (dist) {
        usSelect.disabled = false;
        baseDados[prov][dist].sort().forEach(u => usSelect.options.add(new Option(u, u)));
    }
}

function aplicarMascaraNID(input) {
    let v = input.value.replace(/\D/g, "");
    if (v.length > 19) v = v.slice(0, 19);
    let f = "";
    if (v.length > 0) f = v.slice(0, 10);
    if (v.length > 10) f += "/" + v.slice(10, 14);
    if (v.length > 14) f += "/" + v.slice(14, 19);
    input.value = f;
}

function toggleConfidente() {
    document.getElementById("camposConfidente").style.display = document.getElementById("temConfidente").checked ? "block" : "none";
}

// --- SUBMISS√ÉO E GPS ---
document.getElementById('appForm').onsubmit = function(e) {
    e.preventDefault();
    dadosTemporarios = {
        email_usuario: userEmail,
        provincia: document.getElementById("prov").value,
        distrito: document.getElementById("dist").value,
        us: document.getElementById("us").value,
        nid: document.getElementById("nid").value,
        tem_confidente: document.getElementById("temConfidente").checked ? "Sim" : "N√£o",
        nome_confidente: document.getElementById("nomeConfidente").value || "N/A",
        tel_confidente: document.getElementById("telConfidente").value || "N/A",
        tel1: document.getElementById("tel1").value || "N/A",
        tel2: document.getElementById("tel2").value || "N/A",
        endereco: document.getElementById("endereco").value,
        responsavel: document.getElementById("responsavel").value
    };

    document.getElementById("resumoDados").innerHTML = `
        <p><b>üìç US:</b> ${dadosTemporarios.us}</p>
        <p><b>üÜî NID:</b> ${dadosTemporarios.nid}</p>
        <p><b>üìû Tel:</b> ${dadosTemporarios.tel1} / ${dadosTemporarios.tel2}</p>
        <hr><p class="text-center fw-bold">Deseja gravar este registo?</p>
    `;
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
};

document.getElementById('btnFinalConfirm').onclick = function() {
    const btn = this;
    btn.disabled = true;
    document.getElementById("loader").style.display = "flex";

    navigator.geolocation.getCurrentPosition((pos) => {
        dadosTemporarios.latitude = pos.coords.latitude;
        dadosTemporarios.longitude = pos.coords.longitude;
        enviarParaGoogle();
    }, () => {
        dadosTemporarios.latitude = "GPS Off";
        dadosTemporarios.longitude = "GPS Off";
        enviarParaGoogle();
    }, { timeout: 5000 });
};

function enviarParaGoogle() {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dadosTemporarios) })
    .then(() => {
        alert("Ol√° " + dadosTemporarios.responsavel + ", registo enviado com sucesso!");
        location.reload();
    })
    .catch(() => alert("Erro ao enviar. Tente novamente."));
}
</script>
</body>
</html>

