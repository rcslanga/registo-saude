<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECHO Project Mo칞ambique - Login</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 600px; margin-top: 30px; }
        .form-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-top: 8px solid #C8102E; }
        .logo-container { text-align: center; margin-bottom: 15px; }
        .logo-container img { max-width: 220px; }
        .section-header { background: #003366; color: white; padding: 8px 15px; border-radius: 5px; margin: 20px 0 15px 0; font-weight: bold; font-size: 0.9rem; }
        #appContent { display: none; }
        #loginScreen { text-align: center; padding: 50px 20px; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div class="loading-overlay" id="loader">
    <div class="spinner-border text-danger" role="status"></div>
    <p class="mt-2 fw-bold" id="loaderText">A validar acesso...</p>
</div>

<div class="container mb-5">
    <div id="loginScreen" class="form-card">
        <div class="logo-container">
            <img src="Novo logo ECHO 2025.png" alt="Logo ECHO" onerror="this.src='https://via.placeholder.com/200x80?text=ECHO+PROJECT'">
        </div>
        <h4 class="mb-4" style="color:#003366">Acesso Restrito</h4>
        <p class="text-muted mb-4">Inicie sess칚o para verificar se o seu e-mail est치 autorizado.</p>
        <div id="g_id_onload"
             data-client_id="895843191645-1ioi0feh6ocfu4dabghbda88bagjhrg8.apps.googleusercontent.com"
             data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin d-flex justify-content-center" data-type="standard"></div>
    </div>

    <div id="appContent" class="form-card">
        <div class="logo-container"><img src="Novo logo ECHO 2025.png" alt="Logo ECHO"></div>
        <div class="text-center mb-4">
            <h2 style="color: #003366; font-weight: 800; font-size: 1.4rem;">PROJECTO ECHO</h2>
            <small class="fw-bold" style="color: #C8102E;">Actualiza칞칚o de Endere칞os e Contactos</small>
        </div>

        <form id="appForm">
            <div class="section-header">游늸 LOCALIZA칂츾O DA US</div>
            <div class="mb-3">
                <label class="form-label">Prov칤ncia</label>
                <select id="prov" class="form-select" required onchange="filtrarDistritos()">
                    <option value="">Seleccione...</option>
                    <option value="Manica">Manica</option>
                    <option value="Niassa">Niassa</option>
                    <option value="Sofala">Sofala</option>
                    <option value="Tete">Tete</option>
                </select>
            </div>
            <div class="mb-3">
                <label class="form-label">Distrito</label>
                <select id="dist" class="form-select" required disabled onchange="filtrarUS()"><option value="">Seleccione...</option></select>
            </div>
            <div class="mb-3">
                <label class="form-label">Unidade Sanit치ria (US)</label>
                <select id="us" class="form-select" required disabled><option value="">Seleccione...</option></select>
            </div>

            <div class="section-header">游 IDENTIFICA칂츾O</div>
            <div class="mb-3">
                <label class="form-label">NID (10/4/5 d칤gitos)</label>
                <input type="text" id="nid" class="form-control" maxlength="21" placeholder="0000000000/0000/00000" required oninput="aplicarMascaraNID(this)">
            </div>

            <div class="mb-3">
                <label class="form-label">Endere칞o F칤sico</label>
                <textarea id="endereco" class="form-control" rows="2" required></textarea>
            </div>

            <div class="mb-4">
                <label class="form-label">Nome do Digitador</label>
                <input type="text" id="responsavel" class="form-control" required>
            </div>

            <button type="submit" class="btn btn-primary w-100 p-3 fw-bold shadow" style="background-color:#003366; border:none">SUBMETER REGISTO</button>
        </form>
    </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white"><h5 class="modal-title">Confirmar Dados</h5></div>
            <div class="modal-body" id="resumoDados"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Corrigir</button>
                <button type="button" id="btnFinalConfirm" class="btn btn-success">Confirmar e Gravar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyiH7DLonvttzbczDGe_3hjaaV0Ql9sREqsBzcscZr0nyBj6HtFVlIYiK60MZq1T5Bq7A/exec";
let userEmail = "";
let dadosTemporarios = {};

function parseJwt(token) {
    var base64Url = token.split('.')[1];
    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    return JSON.parse(window.atob(base64));
}

// --- FUN칂츾O DE LOGIN COM VALIDA칂츾O REAL ---
async function handleCredentialResponse(response) {
    const payload = parseJwt(response.credential);
    const emailAValidar = payload.email.toLowerCase().trim();

    document.getElementById("loader").style.display = "flex";
    document.getElementById("loaderText").innerText = "A validar e-mail no sistema...";

    try {
        // Usamos um modo de 'cors' mas o Apps Script vai redirecionar, por isso tratamos o erro ou resposta
        const checkURL = `${SCRIPT_URL}?check=${encodeURIComponent(emailAValidar)}`;
        
        // Chamada ao doGet do Script
        const res = await fetch(checkURL);
        const texto = await res.text();

        if (texto.includes("AUTORIZADO")) {
            userEmail = emailAValidar;
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("appContent").style.display = "block";
        } else {
            alert("ACESSO NEGADO: O e-mail " + emailAValidar + " n칚o est치 autorizado.");
            location.reload();
        }
    } catch (error) {
        console.error(error);
        alert("Erro ao validar acesso. Certifique-se de que o Script est치 implementado como 'Qualquer pessoa'.");
        location.reload();
    } finally {
        document.getElementById("loader").style.display = "none";
    }
}

// --- L칍GICA DO FORMUL츼RIO (Simplificada para o exemplo) ---
function filtrarDistritos() {
    const prov = document.getElementById("prov").value;
    const dist = document.getElementById("dist");
    dist.innerHTML = '<option value="">Seleccione...</option>';
    dist.disabled = false;
    // Aqui viria a l칩gica da baseDados que j치 tem...
    if(prov === "Manica") dist.options.add(new Option("Chimoio", "Chimoio"));
    // ... restante baseDados ...
}

function filtrarUS() {
    const us = document.getElementById("us");
    us.innerHTML = '<option value="">Seleccione...</option>';
    us.disabled = false;
    us.options.add(new Option("US Exemplo", "US Exemplo"));
}

function aplicarMascaraNID(i) { i.value = i.value.replace(/\D/g, "").substring(0,19); }

document.getElementById('appForm').onsubmit = function(e) {
    e.preventDefault();
    dadosTemporarios = {
        email_usuario: userEmail,
        provincia: document.getElementById("prov").value,
        distrito: document.getElementById("dist").value,
        us: document.getElementById("us").value,
        nid: document.getElementById("nid").value,
        endereco: document.getElementById("endereco").value,
        responsavel: document.getElementById("responsavel").value,
        tem_confidente: "N칚o", nome_confidente: "N/A", tel_confidente: "N/A", tel1: "N/A", tel2: "N/A"
    };
    document.getElementById("resumoDados").innerHTML = `<p><b>Utilizador:</b> ${userEmail}</p><p><b>NID:</b> ${dadosTemporarios.nid}</p>`;
    new bootstrap.Modal(document.getElementById('confirmModal')).show();
};

document.getElementById('btnFinalConfirm').onclick = async function() {
    this.disabled = true;
    document.getElementById("loader").style.display = "flex";
    document.getElementById("loaderText").innerText = "A obter GPS e a gravar...";

    navigator.geolocation.getCurrentPosition((pos) => {
        dadosTemporarios.latitude = pos.coords.latitude;
        dadosTemporarios.longitude = pos.coords.longitude;
        enviar();
    }, () => {
        dadosTemporarios.latitude = "Sem GPS";
        dadosTemporarios.longitude = "Sem GPS";
        enviar();
    });
};

function enviar() {
    fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dadosTemporarios) })
    .then(() => { alert("Sucesso!"); location.reload(); })
    .catch(() => alert("Erro ao gravar."));
}
</script>
</body>
</html>
